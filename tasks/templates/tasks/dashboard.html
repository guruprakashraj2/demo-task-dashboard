<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <title>Task Dashboard</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css"/>
    <style>
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            margin: 0; padding: 0;
            background-color: #f4f7f9;
        }
        h1, h2 { text-align: center; color: #333; }
        #dashboardContainer {
            max-width: 900px; margin: 40px auto;
            padding: 20px; background-color: #fff;
            border-radius: 12px; box-shadow: 0 6px 18px rgba(0,0,0,0.1);
        }
        #chartContainer { width: 80%; margin: 30px auto; }
        ul { list-style: none; padding-left: 0; display: flex; flex-wrap: wrap; gap: 15px; justify-content: center; }
        li {
            flex: 1 1 200px; background: #f9f9f9; margin: 5px;
            padding: 15px 20px; border-radius: 10px;
            box-shadow: 0 3px 6px rgba(0,0,0,0.08);
            font-weight: 500; text-align: center;
            display: flex; align-items: center; justify-content: space-between;
        }
        li:hover { transform: translateY(-3px); box-shadow: 0 6px 12px rgba(0,0,0,0.12); }
        .completed { border-left: 5px solid #4caf50; background-color: #e6f4ea; color: #2e7d32; }
        .pending { border-left: 5px solid #f44336; background-color: #fdecea; color: #c62828; }
        #userInfo { text-align: center; margin-top: 30px; font-style: italic; font-size: 1.1em; color: #555; }
        #taskForm input, #taskForm button { padding: 10px; margin: 6px; font-size: 1em; }
        #taskForm button { background: #4caf50; border: none; border-radius: 8px; color: white; cursor: pointer; }
        #taskForm button:hover { background: #43a047; }
        .completeBtn { padding: 5px 8px; font-size: 0.8em; border-radius: 5px; border: none; cursor: pointer; background: #2196f3; color: white; }
        .completeBtn:hover { background: #1976d2; }
    </style>
</head>
<body>
    <div id="dashboardContainer">
        <h1>Task Dashboard</h1>

        <!-- ADD TASK FORM -->
        <h2>Add New Task</h2>
        <form id="taskForm" style="text-align:center; margin-bottom:20px;">
            <input type="text" id="taskTitle" placeholder="Task Title" required>
            <button type="submit">Add Task</button>
        </form>

        <!-- CHART -->
        <div id="chartContainer">
            <canvas id="taskChart" width="400" height="200"></canvas>
        </div>

        <h2>Pending Tasks</h2>
        <ul id="pendingTasks"></ul>

        <h2>Completed Tasks</h2>
        <ul id="completedTasks"></ul>

        <div id="userInfo"></div>
    </div>

    <script>
        // ---------- Load Tasks from API ----------
        async function loadTasks() {
            try {
                const data = await fetch('/api/tasks/').then(res => res.json());

                const completedTasks = data.filter(t => t.completed);
                const pendingTasks = data.filter(t => !t.completed);

                // ---------- Chart ----------
                new Chart(document.getElementById('taskChart'), {
                    type: 'bar',
                    data: {
                        labels: ['Completed', 'Pending'],
                        datasets: [{
                            label: '# of Tasks',
                            data: [completedTasks.length, pendingTasks.length],
                            backgroundColor: ['#4caf50', '#f44336']
                        }]
                    },
                    options: { plugins: { legend: { display: false } }, scales: { y: { beginAtZero: true } } }
                });

                // ---------- Pending List ----------
                const pendingList = document.getElementById("pendingTasks");
                pendingList.innerHTML = "";
                pendingTasks.forEach(t => {
                    const li = document.createElement("li");
                    li.innerHTML = `<span><i class="fa-solid fa-clock"></i> ${t.title}</span><button class="completeBtn">Complete</button>`;
                    li.classList.add("pending");
                    pendingList.appendChild(li);

                    // Mark task as completed
                    li.querySelector(".completeBtn").addEventListener("click", async () => {
                        await fetch(`/api/tasks/${t.id}/`, {
                            method: "PATCH",
                            headers: { "Content-Type": "application/json" },
                            body: JSON.stringify({ completed: true })
                        });
                        loadTasks();
                    });
                });
                if (pendingTasks.length === 0) pendingList.innerHTML = "<li>No pending tasks!</li>";

                // ---------- Completed List ----------
                const completedList = document.getElementById("completedTasks");
                completedList.innerHTML = "";
                completedTasks.forEach(t => {
                    const li = document.createElement("li");
                    li.innerHTML = `<i class="fa-solid fa-check"></i> ${t.title}`;
                    li.classList.add("completed");
                    completedList.appendChild(li);
                });
                if (completedTasks.length === 0) completedList.innerHTML = "<li>No completed tasks!</li>";

            } catch (error) {
                console.error("Error loading tasks:", error);
            }
        }

        // ---------- Add Task (POST) ----------
        document.getElementById("taskForm").addEventListener("submit", async (e) => {
            e.preventDefault();
            const title = document.getElementById("taskTitle").value;
            try {
                await fetch("/api/tasks/", {
                    method: "POST",
                    headers: { "Content-Type": "application/json" },
                    body: JSON.stringify({ title: title, description: "", completed: false })
                });
                document.getElementById("taskTitle").value = "";
                loadTasks();
            } catch (error) {
                console.error("Error adding task:", error);
            }
        });

        // ---------- Load External User API ----------
        async function loadUser() {
            try {
                const data = await fetch('/api/user/').then(res => res.json());
                document.getElementById('userInfo').textContent =
                    `User Info: ${data.name} (${data.email})`;
            } catch (err) { console.error("Error fetching user:", err); }
        }

        loadTasks();
        loadUser();
    </script>
</body>
</html>
